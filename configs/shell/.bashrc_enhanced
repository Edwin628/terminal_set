# Enhanced Bash Configuration
# å¢å¼ºçš„ Bash é…ç½®æ–‡ä»¶ï¼Œæä¾›ç±»ä¼¼ Zsh æ’ä»¶çš„åŠŸèƒ½

# =============================================================================
# åŸºç¡€é…ç½®
# =============================================================================

# å†å²è®°å½•é…ç½®
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTCONTROL=ignoreboth:erasedups
export HISTIGNORE="ls:ll:cd:pwd:clear:history:exit"

# å¯ç”¨å†å²è®°å½•æœç´¢
bind '"\e[A": history-search-backward'
bind '"\e[B": history-search-forward'

# å¯ç”¨è‡ªåŠ¨è¡¥å…¨
if [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
elif [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
fi

# =============================================================================
# ç±»ä¼¼ zsh-autosuggestions çš„åŠŸèƒ½
# =============================================================================

# ä½¿ç”¨ fzf å®ç°å‘½ä»¤å»ºè®®
if command -v fzf >/dev/null 2>&1; then
    # å†å²å‘½ä»¤æœç´¢
    bind '"\C-r": "\C-x1\e^\er"'
    bind -x '"\C-x1": __fzf_history';
    
    __fzf_history() {
        __ehc $(history | fzf --tac --tiebreak=index | perl -ne 'm/^\s*([0-9]+)/ and print "!$1"')
    }
    
    # ç›®å½•æœç´¢
    bind '"\C-t": "\C-x2\e^\er"'
    bind -x '"\C-x2": __fzf_cd';
    
    __fzf_cd() {
        local dir
        dir=$(find ${1:-.} -path '*/\.*' -prune -o -type d -print 2> /dev/null | fzf +m) &&
        cd "$dir"
    }
    
    # æ–‡ä»¶æœç´¢
    bind '"\C-f": "\C-x3\e^\er"'
    bind -x '"\C-x3": __fzf_file';
    
    __fzf_file() {
        local file
        file=$(find ${1:-.} -path '*/\.*' -prune -o -type f -print 2> /dev/null | fzf +m) &&
        ${EDITOR:-vim} "$file"
    }
fi

# =============================================================================
# ç±»ä¼¼ zsh-syntax-highlighting çš„åŠŸèƒ½
# =============================================================================

# ä½¿ç”¨ bash-preexec å®ç°å‘½ä»¤é«˜äº®
if [ -f ~/.bash-preexec.sh ]; then
    source ~/.bash-preexec.sh
    
    # å‘½ä»¤æ‰§è¡Œå‰é«˜äº®
    preexec() {
        echo -e "\033[1;33m$1\033[0m"
    }
fi

# ç®€å•çš„è¯­æ³•æ£€æŸ¥
check_syntax() {
    if [[ $1 == *"&&"* ]] || [[ $1 == *"||"* ]] || [[ $1 == *"|"* ]]; then
        echo -e "\033[1;36må¤åˆå‘½ä»¤: $1\033[0m"
    fi
}

# =============================================================================
# ç±»ä¼¼ zsh-completions çš„åŠŸèƒ½
# =============================================================================

# å¢å¼ºçš„è‡ªåŠ¨è¡¥å…¨
complete -W "$(echo `cat ~/.bash_history 2>/dev/null | tr ' ' '\n' | sort | uniq -c | sort -rn | head -20 | awk '{print $2}'`)" -o default

# Git è‡ªåŠ¨è¡¥å…¨
if [ -f /usr/share/bash-completion/completions/git ]; then
    . /usr/share/bash-completion/completions/git
elif [ -f /etc/bash_completion.d/git ]; then
    . /etc/bash_completion.d/git
fi

# Docker è‡ªåŠ¨è¡¥å…¨
if command -v docker >/dev/null 2>&1; then
    if [ -f /usr/share/bash-completion/completions/docker ]; then
        . /usr/share/bash-completion/completions/docker
    fi
fi

# =============================================================================
# ç±»ä¼¼ zsh-autojump çš„åŠŸèƒ½
# =============================================================================

# ç®€å•çš„ç›®å½•è·³è½¬
j() {
    if [ -z "$1" ]; then
        cd ~
    elif [ -d "$1" ]; then
        cd "$1"
    else
        # æœç´¢å†å²ç›®å½•
        local dir
        dir=$(find ~ -type d -name "*$1*" 2>/dev/null | head -1)
        if [ -n "$dir" ]; then
            cd "$dir"
        else
            echo "ç›®å½•æœªæ‰¾åˆ°: $1"
        fi
    fi
}

# =============================================================================
# ç±»ä¼¼ zsh-history-substring-search çš„åŠŸèƒ½
# =============================================================================

# ä¸Šä¸‹ç®­å¤´æœç´¢å†å²
bind '"\e[A": history-search-backward'
bind '"\e[B": history-search-forward'

# Ctrl+P/Ctrl+N æœç´¢å†å²
bind '"\C-p": history-search-backward'
bind '"\C-n": history-search-forward'

# =============================================================================
# ç±»ä¼¼ zsh-dirhistory çš„åŠŸèƒ½
# =============================================================================

# ç›®å½•å†å²
export DIRHISTORY_SIZE=20
declare -a dirhistory

# è®°å½•ç›®å½•å†å²
cd() {
    builtin cd "$@"
    local dir=$(pwd)
    
    # æ·»åŠ åˆ°å†å²
    dirhistory=("$dir" "${dirhistory[@]}")
    
    # ä¿æŒå†å²å¤§å°
    if [ ${#dirhistory[@]} -gt $DIRHISTORY_SIZE ]; then
        dirhistory=("${dirhistory[@]:0:$DIRHISTORY_SIZE}")
    fi
    
    # å»é‡
    local -a unique_dirs
    for d in "${dirhistory[@]}"; do
        if [[ ! " ${unique_dirs[@]} " =~ " ${d} " ]]; then
            unique_dirs+=("$d")
        fi
    done
    dirhistory=("${unique_dirs[@]}")
}

# ç›®å½•å†å²å¯¼èˆª
dh() {
    if [ -z "$1" ]; then
        echo "ç›®å½•å†å²:"
        for i in "${!dirhistory[@]}"; do
            echo "$i: ${dirhistory[$i]}"
        done
    else
        if [ "$1" -ge 0 ] && [ "$1" -lt ${#dirhistory[@]} ]; then
            cd "${dirhistory[$1]}"
        else
            echo "æ— æ•ˆçš„ç´¢å¼•: $1"
        fi
    fi
}

# =============================================================================
# ç±»ä¼¼ zsh-extract çš„åŠŸèƒ½
# =============================================================================

# é€šç”¨è§£å‹å‡½æ•°
extract() {
    if [ -f $1 ]; then
        case $1 in
            *.tar.bz2)   tar xjf $1     ;;
            *.tar.gz)    tar xzf $1     ;;
            *.bz2)       bunzip2 $1     ;;
            *.rar)       unrar e $1     ;;
            *.gz)        gunzip $1      ;;
            *.tar)       tar xf $1      ;;
            *.tbz2)      tar xjf $1     ;;
            *.tgz)       tar xzf $1     ;;
            *.zip)       unzip $1       ;;
            *.Z)         uncompress $1  ;;
            *.7z)        7z x $1        ;;
            *)          echo "'$1' æ— æ³•è§£å‹" ;;
        esac
    else
        echo "'$1' ä¸æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶"
    fi
}

# =============================================================================
# ç±»ä¼¼ zsh-copypath çš„åŠŸèƒ½
# =============================================================================

# å¤åˆ¶å½“å‰è·¯å¾„åˆ°å‰ªè´´æ¿
copypath() {
    local path=$(pwd)
    if command -v pbcopy >/dev/null 2>&1; then
        # macOS
        echo -n "$path" | pbcopy
    elif command -v xclip >/dev/null 2>&1; then
        # Linux with xclip
        echo -n "$path" | xclip -selection clipboard
    elif command -v xsel >/dev/null 2>&1; then
        # Linux with xsel
        echo -n "$path" | xsel --clipboard --input
    else
        echo "æœªæ‰¾åˆ°å‰ªè´´æ¿å·¥å…·"
        return 1
    fi
    echo "è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: $path"
}

# =============================================================================
# ç±»ä¼¼ zsh-open çš„åŠŸèƒ½
# =============================================================================

# æ‰“å¼€æ–‡ä»¶æˆ–ç›®å½•
o() {
    if [ -z "$1" ]; then
        open .
    else
        open "$1"
    fi
}

# =============================================================================
# ç±»ä¼¼ zsh-sudo çš„åŠŸèƒ½
# =============================================================================

# åŒå‡» ESC æ·»åŠ  sudo
bind '"\e\e": "\C-asudo \C-e"'

# =============================================================================
# ç±»ä¼¼ zsh-colored-man-pages çš„åŠŸèƒ½
# =============================================================================

# å½©è‰² man é¡µé¢
man() {
    env \
        LESS_TERMCAP_mb=$(printf "\e[1;31m") \
        LESS_TERMCAP_md=$(printf "\e[1;31m") \
        LESS_TERMCAP_me=$(printf "\e[0m") \
        LESS_TERMCAP_se=$(printf "\e[0m") \
        LESS_TERMCAP_so=$(printf "\e[1;44;33m") \
        LESS_TERMCAP_ue=$(printf "\e[0m") \
        LESS_TERMCAP_us=$(printf "\e[1;32m") \
        man "$@"
}

# =============================================================================
# ç±»ä¼¼ zsh-command-not-found çš„åŠŸèƒ½
# =============================================================================

# å‘½ä»¤æœªæ‰¾åˆ°æ—¶çš„å»ºè®®
command_not_found_handle() {
    local cmd="$1"
    echo "å‘½ä»¤æœªæ‰¾åˆ°: $cmd"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼çš„å‘½ä»¤
    if command -v fzf >/dev/null 2>&1; then
        echo "æœç´¢ç±»ä¼¼å‘½ä»¤..."
        compgen -c | grep -i "$cmd" | head -5
    fi
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…
    if command -v apt >/dev/null 2>&1; then
        echo "å°è¯•: apt search $cmd"
    elif command -v brew >/dev/null 2>&1; then
        echo "å°è¯•: brew search $cmd"
    fi
    
    return 127
}

# =============================================================================
# ç±»ä¼¼ zsh-autosuggestions çš„æç¤ºåŠŸèƒ½
# =============================================================================

# ç®€å•çš„å‘½ä»¤æç¤º
__bash_prompt() {
    local last_cmd=$?
    local cmd_suggestions=""
    
    # åŸºäºå†å²è®°å½•çš„å»ºè®®
    if [ -n "$COMP_LINE" ]; then
        local current_input="${COMP_LINE% *}"
        local suggestions=$(history | grep "$current_input" | tail -3 | sed 's/^[[:space:]]*[0-9]*[[:space:]]*//')
        if [ -n "$suggestions" ]; then
            cmd_suggestions="\033[2;37må»ºè®®: $suggestions\033[0m"
        fi
    fi
    
    # æ˜¾ç¤ºå»ºè®®
    if [ -n "$cmd_suggestions" ]; then
        echo -e "$cmd_suggestions"
    fi
}

# =============================================================================
# æç¤ºç¬¦é…ç½®
# =============================================================================

# å½©è‰²æç¤ºç¬¦
if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
    # SSH è¿æ¥
    PS1='\[\033[1;31m\]\u@\h\[\033[0m\]:\[\033[1;34m\]\w\[\033[0m\]\$ '
else
    # æœ¬åœ°è¿æ¥
    PS1='\[\033[1;32m\]\u@\h\[\033[0m\]:\[\033[1;34m\]\w\[\033[0m\]\$ '
fi

# Git åˆ†æ”¯æ˜¾ç¤º
if command -v git >/dev/null 2>&1; then
    parse_git_branch() {
        git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
    }
    PS1='\[\033[1;32m\]\u@\h\[\033[0m\]:\[\033[1;34m\]\w\[\033[1;33m\]$(parse_git_branch)\[\033[0m\]\$ '
fi

# =============================================================================
# åˆ«å
# =============================================================================

# å¸¸ç”¨åˆ«å
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'

# Git åˆ«å
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git log --oneline'
alias gd='git diff'

# ç³»ç»Ÿåˆ«å
alias df='df -h'
alias du='du -h'
alias free='free -h'
alias top='htop'

# å®‰å…¨åˆ«å
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# =============================================================================
# ç¯å¢ƒå˜é‡
# =============================================================================

# ç¼–è¾‘å™¨
export EDITOR=vim
export VISUAL=vim

# è¯­è¨€ç¯å¢ƒ
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# è·¯å¾„
export PATH="$HOME/.local/bin:$PATH"

# =============================================================================
# å¹³å°ç‰¹å®šé…ç½®
# =============================================================================

# macOS ç‰¹å®šé…ç½®
if [[ "$OSTYPE" == "darwin"* ]]; then
    # Homebrew
    if command -v brew >/dev/null 2>&1; then
        eval "$(brew shellenv)"
    fi
    
    # å¯ç”¨é¢œè‰²
    export CLICOLOR=1
    export LSCOLORS=ExFxBxDxCxegedabagacad
    
    # åˆ«å
    alias showfiles='defaults write com.apple.finder AppleShowAllFiles YES; killall Finder'
    alias hidefiles='defaults write com.apple.finder AppleShowAllFiles NO; killall Finder'
fi

# Linux ç‰¹å®šé…ç½®
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # å¯ç”¨é¢œè‰²
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# =============================================================================
# åŠ è½½é¢å¤–é…ç½®
# =============================================================================

# åŠ è½½æœ¬åœ°é…ç½®
if [ -f ~/.bashrc.local ]; then
    . ~/.bashrc.local
fi

# åŠ è½½å·¥ä½œç›¸å…³é…ç½®
if [ -f ~/.bashrc.work ]; then
    . ~/.bashrc.work
fi

echo "ğŸš å¢å¼ºçš„ Bash é…ç½®å·²åŠ è½½"
echo "ğŸ“š å¯ç”¨åŠŸèƒ½: è‡ªåŠ¨è¡¥å…¨ã€å†å²æœç´¢ã€ç›®å½•è·³è½¬ã€å‘½ä»¤æç¤ºç­‰" 